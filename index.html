<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Crypto Scalp Margin Calculator</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body {
      font-family: Poppins, system-ui;
      background: #0b1220;
      color: #e6eef8;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
    }
    .card {
      background: #0f1724;
      padding: 25px;
      border-radius: 16px;
      width: 340px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.6);
    }
    input, select {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border-radius: 8px;
      border: 1px solid #263044;
      background: #061221;
      color: #e6eef8;
    }
    button {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: none;
      background: #f97316;
      color: #071322;
      font-weight: 700;
      margin-top: 10px;
      transition: background .2s;
    }
    button:hover { background: #fb923c; }
    .out {
      margin-top: 15px;
      padding: 12px;
      border-radius: 8px;
      background: #081426;
      color: #cfe9ff;
      font-size: 14px;
      line-height: 1.5em;
    }
    h3 { text-align: center; margin-top: 0; color: #f97316; }
    .tp-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
    }
    .tp-row label {
      flex: 1;
      text-align: left;
    }
    #tpToggle {
      width: auto;
      margin: 0;
    }
    .highlight {
      color: #f97316;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="card">
    <h3>Crypto Scalp Margin Calculator</h3>

    <label>Risk Type</label>
    <select id="riskType" onchange="toggleMode()">
      <option value="fixed">Fixed ($)</option>
      <option value="percent">% of Capital</option>
    </select>

    <div id="capitalWrapper" style="display:none">
      <label>Total Capital (USDT)</label>
      <input id="capital" type="text" placeholder="e.g. 100">
    </div>

    <label id="riskLabel">Risk ($)</label>
    <input id="riskValue" type="text" placeholder="e.g. 2">

    <label>Entry Price</label>
    <input id="entry" type="text" placeholder="e.g. 30,000">

    <label>Stop Loss Price</label>
    <input id="stop" type="text" placeholder="e.g. 29,990">

    <div class="tp-row">
      <input type="checkbox" id="tpToggle" onchange="toggleTakeProfit()">
      <label for="tpToggle">Enable Take Profit</label>
    </div>
    <input id="takeProfit" type="text" placeholder="e.g. 30,200" disabled>

    <label>Leverage (x)</label>
    <input id="leverage" type="text" value="100">

    <button onclick="calc()">Calculate</button>
    <button style="background:#334155;color:#fff;" onclick="eraseAll()">Erase All</button>

    <div class="out" id="out">Enter values and press Calculate</div>
  </div>

<script>
function toggleMode(){
  const riskType = document.getElementById('riskType').value;
  const capWrapper = document.getElementById('capitalWrapper');
  const riskLabel = document.getElementById('riskLabel');
  const riskInput = document.getElementById('riskValue');

  if(riskType === 'percent'){
    capWrapper.style.display = 'block';
    riskLabel.innerText = 'Risk (%)';
    riskInput.placeholder = 'e.g. 1';
  } else {
    capWrapper.style.display = 'none';
    riskLabel.innerText = 'Risk ($)';
    riskInput.placeholder = 'e.g. 2';
  }
}

function toggleTakeProfit(){
  const tp = document.getElementById('takeProfit');
  const toggle = document.getElementById('tpToggle');
  tp.disabled = !toggle.checked;
  if(!toggle.checked){
    tp.value = '';
  }
}

function eraseAll(){
  document.querySelectorAll('input').forEach(i=>{
    if(i.type !== 'checkbox') i.value='';
    if(i.id==='takeProfit') i.disabled=true;
    if(i.id==='tpToggle') i.checked=false;
  });
  document.getElementById('out').innerText='Enter values and press Calculate';
}

// --- Fix input comma formatting (with correct caret position) ---
document.querySelectorAll('input[type="text"]').forEach(input=>{
  input.addEventListener('input', e=>{
    const selectionStart = input.selectionStart;
    const raw = input.value.replace(/,/g, '');
    if(isNaN(raw) || raw === '') return;
    const formatted = parseFloat(raw).toLocaleString('en-US');
    const diff = formatted.length - raw.length;
    input.value = formatted;
    input.setSelectionRange(selectionStart + diff, selectionStart + diff);
  });
});

function formatNumber(num, decimals = 2) {
  return num.toLocaleString('en-US', {minimumFractionDigits: decimals, maximumFractionDigits: decimals});
}

function parseNumber(val){
  return parseFloat(val.replace(/,/g,''));
}

function calc(){
  const riskType = document.getElementById('riskType').value;
  const entry = parseNumber(document.getElementById('entry').value);
  const stop = parseNumber(document.getElementById('stop').value);
  const lev = parseNumber(document.getElementById('leverage').value);
  const tpToggle = document.getElementById('tpToggle').checked;
  const tpValue = parseNumber(document.getElementById('takeProfit').value);
  const out = document.getElementById('out');

  if(!entry || !stop || !lev){
    out.innerText = "‚ö†Ô∏è Please enter entry, stop, and leverage.";
    return;
  }

  let riskUsd = 0;
  if(riskType === 'percent'){
    const cap = parseNumber(document.getElementById('capital').value);
    const riskPct = parseNumber(document.getElementById('riskValue').value);
    if(!cap || !riskPct){out.innerText = "‚ö†Ô∏è Enter capital and risk %.";return;}
    riskUsd = cap * (riskPct / 100);
  } else {
    const riskVal = parseNumber(document.getElementById('riskValue').value);
    if(!riskVal){out.innerText = "‚ö†Ô∏è Enter fixed risk amount.";return;}
    riskUsd = riskVal;
  }

  const stopDist = Math.abs(entry - stop);
  if(stopDist === 0){out.innerText = "‚ö†Ô∏è Stop distance cannot be zero.";return;}

  const qty = riskUsd / stopDist;
  const notional = qty * entry;
  const margin = notional / lev;
  const stopPercent = (stopDist / entry) * 100;

  let result = `
    üßÆ <b>Stop Distance:</b> ${formatNumber(stopPercent, 3)}%<br>
    üí∞ <b>Risk Amount:</b> $${formatNumber(riskUsd)}<br>
    ‚öôÔ∏è <b>Quantity:</b> ${formatNumber(qty, 6)} units<br>
    üìà <b>Position Size:</b> $${formatNumber(notional)}<br>
    üíµ <b class="highlight">Margin Required:</b> $${formatNumber(margin)}<br>
    ‚öñÔ∏è <b>Leverage:</b> ${formatNumber(lev, 0)}x<br>
  `;

  if(tpToggle && tpValue){
    const tpDist = Math.abs(tpValue - entry);
    const rr = tpDist / stopDist;
    const profit = riskUsd * rr;
    const tpPercent = (tpDist / entry) * 100;
    result += `
      <br>üéØ <b>Take Profit:</b> $${formatNumber(tpValue)}<br>
      üíπ <b class="highlight">Reward : Risk Ratio:</b> ${formatNumber(rr, 2)}R<br>
      üíµ <b class="highlight">Profit if TP Hit:</b> $${formatNumber(profit)}<br>
    `;
  } else {
    result += `<br>üéØ <b>Take Profit:</b> <span style="color:#f87171;">Not defined</span>`;
  }

  out.innerHTML = result;
}
</script>
</body>
</html>
